<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebuy Rule Extractor (Robust)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .rule-card { border-left: 4px solid #3b82f6; }
        .rule-card:hover { transform: translateX(2px); }
    </style>
</head>
<body class="text-gray-800 p-6 md:p-12">

    <div class="max-w-6xl mx-auto">
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Rebuy Rule Extractor</h1>
            <p class="text-gray-500 mt-2">Extracts rules from large Rebuy source files using robust parsing.</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
            <div class="flex gap-4 mb-4 border-b border-gray-100 pb-4">
                <button onclick="setMode('file')" id="btn-file" class="text-blue-600 font-bold border-b-2 border-blue-600 pb-1">Upload File</button>
                <button onclick="setMode('paste')" id="btn-paste" class="text-gray-500 font-medium pb-1 hover:text-blue-600">Paste Text</button>
            </div>

            <div id="mode-file" class="block">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-8 h-8 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500">Supports .txt, .html</p>
                    </div>
                    <input id="fileInput" type="file" class="hidden" />
                </label>
            </div>

            <div id="mode-paste" class="hidden">
                <textarea id="pasteArea" class="w-full h-64 p-4 border border-gray-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Paste your code here..."></textarea>
                <button onclick="processPaste()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">Process Text</button>
            </div>

            <div id="status" class="mt-4 font-medium text-sm hidden"></div>
        </div>

        <div id="toolbar" class="hidden flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Rules Found: <span id="ruleCount" class="text-blue-600">0</span></h2>
            <div class="flex gap-2">
                <button onclick="copyResults('text')" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition-colors">Copy Text</button>
                <button onclick="copyResults('csv')" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition-colors">Copy CSV</button>
            </div>
        </div>

        <div id="output" class="space-y-4 hidden"></div>

    </div>

    <script>
        // --- State ---
        let rulesData = [];

        // --- UI Logic ---
        function setMode(mode) {
            document.getElementById('mode-file').classList.toggle('hidden', mode !== 'file');
            document.getElementById('mode-paste').classList.toggle('hidden', mode !== 'paste');
            
            const btnFile = document.getElementById('btn-file');
            const btnPaste = document.getElementById('btn-paste');
            
            if(mode === 'file') {
                btnFile.className = "text-blue-600 font-bold border-b-2 border-blue-600 pb-1";
                btnPaste.className = "text-gray-500 font-medium pb-1 hover:text-blue-600";
            } else {
                btnPaste.className = "text-blue-600 font-bold border-b-2 border-blue-600 pb-1";
                btnFile.className = "text-gray-500 font-medium pb-1 hover:text-blue-600";
            }
        }

        // --- Event Listeners ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            showStatus("Reading file...", "text-blue-600");
            
            const reader = new FileReader();
            reader.onload = function(e) {
                processContent(e.target.result);
            };
            reader.readAsText(file);
        });

        function processPaste() {
            const content = document.getElementById('pasteArea').value;
            if(!content.trim()) return showStatus("Please paste some text first.", "text-red-600");
            processContent(content);
        }

        function showStatus(msg, colorClass) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `mt-4 font-medium text-sm block ${colorClass}`;
        }

        // --- The Robust Parser ---
        function processContent(content) {
            showStatus("Analyzing content...", "text-blue-600");

            let dataSource = null;

            try {
                // 1. Try "Brace Counting" extraction for 'data.data_source ='
                // This is robust against large files where Regex fails.
                const searchStr = "data.data_source =";
                const startIndex = content.indexOf(searchStr);

                if (startIndex !== -1) {
                    // Find the first '{' after the assignment
                    let openBraceIndex = content.indexOf('{', startIndex);
                    if (openBraceIndex !== -1) {
                        let braceCount = 1;
                        let i = openBraceIndex + 1;
                        
                        // Loop until braces match up
                        while (braceCount > 0 && i < content.length) {
                            if (content[i] === '{') braceCount++;
                            else if (content[i] === '}') braceCount--;
                            i++;
                        }

                        if (braceCount === 0) {
                            const jsonString = content.substring(openBraceIndex, i);
                            dataSource = JSON.parse(jsonString);
                        }
                    }
                }
                
                // 2. Fallback: Try parsing the whole file as JSON
                if (!dataSource) {
                    try {
                        dataSource = JSON.parse(content);
                    } catch(e) {}
                }

                if (dataSource && (dataSource.rules || (dataSource.data_source && dataSource.data_source.rules))) {
                    const rules = dataSource.rules || dataSource.data_source.rules;
                    renderRules(rules);
                    showStatus("Successfully extracted rules!", "text-green-600");
                } else {
                    showStatus("Could not find 'data.data_source' configuration. Ensure you uploaded the correct Source Code file.", "text-red-600");
                }

            } catch (err) {
                console.error(err);
                showStatus("Error parsing file: " + err.message, "text-red-600");
            }
        }

        // --- Rendering ---
        function renderRules(rules) {
            const container = document.getElementById('output');
            container.innerHTML = '';
            rulesData = []; // Reset global data

            if (!rules.length) {
                container.innerHTML = '<div class="text-center text-gray-500">No rules found.</div>';
                return;
            }

            rules.forEach((rule, index) => {
                // Extract Inputs
                const inputs = [];
                if (rule.logic) {
                    rule.logic.forEach(group => {
                        if (group.rules) {
                            group.rules.forEach(r => {
                                // Extract Trigger Products
                                if (r.products) {
                                    r.products.forEach(p => {
                                        inputs.push({
                                            id: p.product_id,
                                            title: p.json?.title || "Unknown Product"
                                        });
                                    });
                                }
                            });
                        }
                    });
                }

                // Extract Outputs
                const outputs = [];
                if (rule.output) {
                    rule.output.forEach(out => {
                        // Extract Return Products
                        if (out.products) {
                            out.products.forEach(p => {
                                outputs.push({
                                    id: p.product_id,
                                    title: p.json?.title || "Unknown Product"
                                });
                            });
                        }
                    });
                }

                // Save to state
                rulesData.push({ id: index + 1, inputs, outputs });

                // Render Card
                const card = document.createElement('div');
                card.className = "rule-card bg-white p-6 rounded-lg shadow-sm border border-gray-200 transition-all duration-200";
                
                const inputHTML = inputs.length 
                    ? inputs.map(i => `<div class="text-blue-700 font-medium">IF ${i.title} <span class="text-gray-400 text-xs">(${i.id})</span></div>`).join('') 
                    : `<div class="text-gray-400 italic">IF Anything (Global Rule)</div>`;

                const outputHTML = outputs.length 
                    ? outputs.map(o => `<div class="text-green-700 font-medium">RETURN ${o.title} <span class="text-gray-400 text-xs">(${o.id})</span></div>`).join('') 
                    : `<div class="text-gray-400 italic">No return action</div>`;

                card.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="md:w-16 flex-shrink-0 pt-1">
                            <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">#${index + 1}</span>
                        </div>
                        <div class="flex-1 space-y-2">
                            ${inputHTML}
                        </div>
                        <div class="flex items-center justify-center text-gray-300 px-4">
                            <svg class="w-6 h-6 transform rotate-90 md:rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </div>
                        <div class="flex-1 space-y-2">
                            ${outputHTML}
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            document.getElementById('ruleCount').innerText = rules.length;
            document.getElementById('toolbar').classList.remove('hidden');
            container.classList.remove('hidden');
        }

        // --- Copy Logic ---
        function copyResults(format) {
            let text = "";
            if (format === 'csv') {
                text = "Rule ID,Type,Product Name,Product ID\n";
                rulesData.forEach(r => {
                    r.inputs.forEach(i => text += `${r.id},IF,"${i.title.replace(/"/g, '""')}",${i.id}\n`);
                    r.outputs.forEach(o => text += `${r.id},RETURN,"${o.title.replace(/"/g, '""')}",${o.id}\n`);
                });
            } else {
                rulesData.forEach(r => {
                    text += `RULE #${r.id}\n`;
                    if(r.inputs.length === 0) text += `  IF: Anything\n`;
                    r.inputs.forEach(i => text += `  IF: ${i.title} (${i.id})\n`);
                    r.outputs.forEach(o => text += `  RETURN: ${o.title} (${o.id})\n`);
                    text += "\n";
                });
            }
            
            navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
        }
    </script>
</body>
</html>