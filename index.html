<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebuy HTML Rule Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen font-sans">

    <div class="max-w-5xl mx-auto p-6 md:p-12">
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2 flex items-center gap-3">
                <i class="ph ph-magic-wand text-blue-600"></i>
                Rebuy Rule Extractor
            </h1>
            <p class="text-slate-500">Upload the <strong>Rebuy Page HTML</strong> file you just saved. We will find the hidden rules inside.</p>
        </div>

        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mb-8 transition-colors hover:border-blue-300" id="dropZone">
            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <i class="ph ph-upload-simple text-3xl text-slate-400 mb-2"></i>
                    <p class="mb-1 text-sm text-slate-500"><span class="font-semibold">Click to upload</span> your 'file.txt' or '.html'</p>
                </div>
                <input id="fileInput" type="file" class="hidden" accept=".txt,.html,.json" />
            </label>
            <div id="status" class="mt-4 text-center text-sm font-medium hidden"></div>
        </div>

        <div id="outputContainer" class="hidden animate-fade-in-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                    Found <span id="ruleCount" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-sm">0</span> Rules
                </h2>
                <div class="flex gap-2">
                    <button onclick="copyToClipboard('readable')" class="flex items-center gap-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded-md text-sm transition-all shadow-sm">
                        <i class="ph ph-text-aa"></i> Copy Text
                    </button>
                    <button onclick="copyToClipboard('csv')" class="flex items-center gap-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded-md text-sm transition-all shadow-sm">
                        <i class="ph ph-table"></i> Copy CSV
                    </button>
                </div>
            </div>

            <div id="rulesList" class="space-y-3 mb-6 max-h-[500px] overflow-y-auto custom-scrollbar p-1">
                </div>
            
            <textarea id="copySource" class="hidden"></textarea>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-2 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none z-50">
        Copied to clipboard!
    </div>

    <script>
        // --- Core Logic ---
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const outputContainer = document.getElementById('outputContainer');
        const rulesList = document.getElementById('rulesList');
        const ruleCount = document.getElementById('ruleCount');

        let globalRules = [];

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.textContent = "Scanning file for Rebuy data...";
            status.className = "mt-4 text-center text-sm font-medium text-blue-600 block";
            
            const text = await file.text();
            processRebuyFile(text);
        });

        function processRebuyFile(content) {
            let dataSource = null;

            // STRATEGY 1: Look for the specific "data.data_source =" assignment common in Rebuy HTML
            // We use a regex that captures the JSON object assigned to data.data_source
            const regexDataSource = /data\.data_source\s*=\s*(\{[\s\S]*?\});/;
            const match1 = content.match(regexDataSource);

            // STRATEGY 2: Look for just "data =" (sometimes used in different versions)
            const regexDataGeneric = /data\s*=\s*(\{[\s\S]*?"rules"[\s\S]*?\});/;
            const match2 = content.match(regexDataGeneric);

            try {
                if (match1 && match1[1]) {
                    dataSource = JSON.parse(match1[1]);
                } else if (match2 && match2[1]) {
                    dataSource = JSON.parse(match2[1]);
                } else {
                    // STRATEGY 3: Try parsing the whole file as JSON (if user uploaded just the API response)
                    dataSource = JSON.parse(content);
                }
            } catch (err) {
                console.error("JSON Parse Error", err);
            }

            // Validation
            if (!dataSource || (!dataSource.rules && !dataSource.data_source?.rules)) {
                status.textContent = "Could not find 'rules' in this file. Make sure it's a Rebuy Data Source file.";
                status.className = "mt-4 text-center text-sm font-medium text-red-500 block";
                return;
            }

            // Normalize structure (sometimes rules are nested)
            const rules = dataSource.rules || dataSource.data_source.rules;
            
            status.textContent = "Success! Rules extracted.";
            status.className = "mt-4 text-center text-sm font-medium text-green-600 block";
            
            displayRules(rules);
        }

        function displayRules(rules) {
            globalRules = []; // Reset
            rulesList.innerHTML = '';

            if (rules.length === 0) {
                rulesList.innerHTML = '<div class="text-center text-slate-400 italic">No rules found in this data source.</div>';
                return;
            }

            rules.forEach((rule, index) => {
                const parsed = parseSingleRule(rule);
                globalRules.push(parsed);

                // Create UI Card
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-sm";
                
                let inputs = parsed.inputs.map(i => `<span class="inline-block bg-blue-50 text-blue-700 border border-blue-100 rounded px-2 py-0.5 mr-2 mb-1">IF ${i.name} (${i.id})</span>`).join('');
                if(!inputs) inputs = `<span class="text-slate-400 italic">IF Anything</span>`;

                let outputs = parsed.outputs.map(o => `<span class="inline-block bg-green-50 text-green-700 border border-green-100 rounded px-2 py-0.5 mr-2 mb-1">RETURN ${o.name} (${o.id})</span>`).join('');
                if(!outputs) outputs = `<span class="text-slate-400 italic">RETURN Nothing</span>`;

                card.innerHTML = `
                    <div class="font-bold text-slate-400 text-xs mb-2 uppercase tracking-wider">Rule #${index + 1}</div>
                    <div class="mb-2">${inputs}</div>
                    <div class="border-t border-slate-100 pt-2">${outputs}</div>
                `;
                rulesList.appendChild(card);
            });

            ruleCount.innerText = rules.length;
            outputContainer.classList.remove('hidden');
        }

        function parseSingleRule(rule) {
            const inputs = [];
            const outputs = [];

            // Parse Inputs (IF conditions)
            if (rule.logic) {
                rule.logic.forEach(group => {
                    if (group.rules) {
                        group.rules.forEach(r => {
                            if (r.products) {
                                r.products.forEach(p => {
                                    inputs.push({
                                        id: p.product_id,
                                        name: p.json?.title || "Unknown Product"
                                    });
                                });
                            }
                        });
                    }
                });
            }

            // Parse Outputs (RETURN actions)
            if (rule.output) {
                rule.output.forEach(out => {
                    if (out.products) {
                        out.products.forEach(p => {
                            outputs.push({
                                id: p.product_id,
                                name: p.json?.title || "Unknown Product"
                            });
                        });
                    }
                });
            }

            return { inputs, outputs };
        }

        function copyToClipboard(format) {
            let text = "";
            
            if (format === 'csv') {
                text = "Rule #,Type,Product Name,Product ID\n";
                globalRules.forEach((r, i) => {
                    r.inputs.forEach(input => text += `${i+1},IF,"${input.name.replace(/"/g, '""')}",${input.id}\n`);
                    r.outputs.forEach(output => text += `${i+1},RETURN,"${output.name.replace(/"/g, '""')}",${output.id}\n`);
                });
            } else {
                globalRules.forEach((r, i) => {
                    text += `RULE ${i+1}\n`;
                    r.inputs.forEach(input => text += `  IF: ${input.name} (${input.id})\n`);
                    if(r.inputs.length === 0) text += `  IF: Anything\n`;
                    
                    r.outputs.forEach(output => text += `  THEN RETURN: ${output.name} (${output.id})\n`);
                    text += "\n";
                });
            }

            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 2000);
            });
        }
    </script>
</body>
</html>