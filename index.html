<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebuy to Dynamatic Importer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .json-output { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 11px; line-height: 1.5; }
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #1e293b; }
        textarea::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="p-6 md:p-10 text-slate-800 h-screen flex flex-col">

    <div class="max-w-7xl mx-auto w-full flex-1 flex flex-col">
        
        <div class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                    <i class="ph-fill ph-arrows-left-right text-blue-600"></i>
                    Rebuy to Dynamatic Converter
                </h1>
                <p class="text-sm text-slate-500 mt-1">Converts Rebuy source code into a JSON file ready for import.</p>
            </div>
            <div id="statusTag" class="hidden px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold items-center gap-1">
                <i class="ph-bold ph-check"></i> Converted
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
            
            <div class="flex flex-col h-full bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-slate-700 text-sm uppercase tracking-wide">1. Source Code</h2>
                    <span class="text-xs text-slate-400">Paste file.txt / HTML</span>
                </div>
                <textarea id="inputArea" class="flex-1 w-full p-4 border border-slate-200 rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none resize-none bg-slate-50 text-slate-600" placeholder="Paste the Rebuy source code here..."></textarea>
                <div class="mt-4">
                    <button onclick="convertData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 shadow-sm">
                        <i class="ph-bold ph-magic-wand"></i> Convert to Dynamatic Format
                    </button>
                </div>
            </div>

            <div class="flex flex-col h-full bg-slate-900 p-5 rounded-xl shadow-lg border border-slate-700">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-slate-100 text-sm uppercase tracking-wide">2. Import JSON</h2>
                    <div class="flex gap-2">
                        <button onclick="copyOutput()" class="text-xs font-medium text-slate-400 hover:text-white transition-colors flex items-center gap-1 px-2 py-1 hover:bg-slate-800 rounded">
                            <i class="ph-bold ph-copy"></i> Copy Text
                        </button>
                        <button onclick="downloadOutput()" id="dlBtn" disabled class="text-xs font-bold text-white bg-green-600 hover:bg-green-700 transition-colors flex items-center gap-1 px-3 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-bold ph-download-simple"></i> Download .json
                        </button>
                    </div>
                </div>
                <textarea id="outputArea" readonly class="flex-1 w-full p-4 border border-slate-700 rounded-lg json-output focus:outline-none resize-none bg-slate-950 text-green-400" placeholder="// JSON output will appear here..."></textarea>
            </div>
        </div>

    </div>

    <script>
        // --- UUID Generator for Dynamatic IDs ---
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Core Conversion Logic ---
        function convertData() {
            const input = document.getElementById('inputArea').value;
            const statusTag = document.getElementById('statusTag');
            const dlBtn = document.getElementById('dlBtn');

            if (!input.trim()) return alert("Please paste the source code first.");

            try {
                // 1. Robust Extraction of Rebuy Data
                let dataSource = null;
                const marker = "data.data_source =";
                const idx = input.indexOf(marker);
                
                if (idx !== -1) {
                    let open = 0, start = -1, found = false;
                    for (let i = idx; i < input.length; i++) {
                        if (input[i] === '{') {
                            if (!found) { start = i; found = true; }
                            open++;
                        } else if (input[i] === '}') {
                            open--;
                        }
                        if (found && open === 0) {
                            // Safe evaluation of JS object to handle unquoted keys
                            const objStr = input.substring(start, i + 1);
                            dataSource = new Function("return " + objStr)();
                            break;
                        }
                    }
                } else {
                    // Fallback for direct JSON paste
                    try { dataSource = JSON.parse(input); } catch(e) {}
                }

                if (!dataSource || (!dataSource.rules && !dataSource.data_source?.rules)) {
                    throw new Error("Could not find 'rules' in the provided text. Make sure you pasted the full source.");
                }

                const rebuyRules = dataSource.rules || dataSource.data_source.rules;
                
                // 2. Map to Dynamatic Schema
                const dynamaticFeed = {
                    "status": 200,
                    "message": "Converted successfully via Tool",
                    "rule_feed": {
                        "id": parseInt(dataSource.id) || Math.floor(Math.random() * 1000),
                        "shop_url": "imported-shop.myshopify.com", 
                        "name": dataSource.name || "Rebuy Import Feed",
                        "filter_out_stock_product": 0,
                        "filter_out_stock_variant": 0,
                        "filter_input_product": 0,
                        "execution_filters": [],
                        "rules": rebuyRules.map(transformRule)
                    }
                };

                // 3. Output Result
                const finalJSON = JSON.stringify(dynamaticFeed, null, 4);
                document.getElementById('outputArea').value = finalJSON;
                
                // UI Updates
                statusTag.classList.remove('hidden');
                statusTag.classList.add('flex');
                dlBtn.removeAttribute('disabled');

            } catch (err) {
                console.error(err);
                alert("Conversion Error: " + err.message);
            }
        }

        function transformRule(r) {
            return {
                "id": uuidv4(),
                "isMatched": false,
                "name": r.name || "Imported Rebuy Rule",
                "logics": [
                    // Dynamatic uses double array nesting for logics: [[ {block} ]]
                    mapProductBlock(r.logic, "products", "contains")
                ],
                "returns": mapProductBlock(r.output, "specific-product", null) 
            };
        }

        function mapProductBlock(block, blockName, typeValue) {
            let allProducts = [];

            if (block && Array.isArray(block)) {
                block.forEach(group => {
                    // Rebuy structure varies: logic uses 'rules', output uses 'products'
                    const subList = group.rules || (group.products ? [group] : []);
                    
                    subList.forEach(item => {
                        if (item.products) {
                            item.products.forEach(p => {
                                allProducts.push(transformProduct(p));
                            });
                        }
                    });
                });
            }

            if (allProducts.length === 0) return [];

            // Return array of blocks (Dynamatic format)
            return [{
                "id": uuidv4(),
                "name": blockName,
                "type": typeValue, // 'contains' for logic, null for output
                "value": allProducts
            }];
        }

        function transformProduct(p) {
            const meta = p.json || {}; 

            return {
                "product_id": String(p.product_id),
                "product_title": meta.title || "Unknown Title",
                "product_handle": meta.handle || "",
                "product_image": (meta.image && meta.image.src) ? meta.image.src : (typeof meta.image === 'string' ? meta.image : ""),
                "product_variants": (meta.variants || []).map(v => ({
                    "variant_id": String(v.id),
                    "variant_title": v.title || "Default Title",
                    "variant_available": v.available !== false, 
                    "variant_price": String(v.price || "0.00"),
                    "inventory_policy": v.inventory_policy || "DENY",
                    "inventory_quantity": v.inventory_quantity || 0,
                    "compare_at_price": v.compare_at_price || 0
                })),
                "product_vendor": meta.vendor || "",
                "product_status": "ACTIVE"
            };
        }

        // --- Actions ---
        function copyOutput() {
            const content = document.getElementById('outputArea').value;
            if (!content) return;
            navigator.clipboard.writeText(content).then(() => alert("Copied to clipboard!"));
        }

        function downloadOutput() {
            const content = document.getElementById('outputArea').value;
            if (!content) return;

            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Name the file nicely
            a.href = url;
            a.download = 'dynamatic_rules_import.json';
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>